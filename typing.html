<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Practice - NoobDev</title>
    <style>
        /* --- CORE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            background: #0a2647;
            color: white;
            min-height: 100vh;
        }
        
        /* Animation Fade In */
        .hero {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a2647 0%, #1a4d7a 50%, #2c7da0 100%);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: fadeInPage 0.8s ease-out;
        }

        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Nav Styles */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 60px; position: relative; z-index: 100;
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .logo { font-size: 32px; font-weight: 700; color: white; letter-spacing: -0.5px; }
        
        /* Menu Toggle Button */
        .menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-between;
            width: 30px;
            height: 21px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }
        .menu-toggle span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        /* Side Menu */
        .side-menu {
            position: fixed; top: 0; left: -300px; width: 250px; height: 100%;
            background: rgba(10, 38, 71, 0.95); backdrop-filter: blur(15px);
            z-index: 1000; padding-top: 80px; transition: left 0.3s ease-in-out;
            box-shadow: 2px 0 15px rgba(0,0,0,0.5); display: flex; flex-direction: column;
        }
        .side-menu.active { left: 0; }
        .side-menu ul { list-style: none; padding: 0; }
        .side-menu li { width: 100%; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .side-menu a { display: block; padding: 15px 30px; color: white; text-decoration: none; font-size: 18px; transition: background 0.3s; }
        .side-menu a:hover { background: rgba(255,255,255,0.1); color: #4a8dbf; }

        .nav-links { display: flex; gap: 35px; align-items: center; }
        .nav-links a { color: white; text-decoration: none; font-size: 16px; font-weight: 500; transition: all 0.3s ease; position: relative; }
        .nav-links a:not(.login-btn):hover { color: #4a8dbf; transform: translateY(-1px); }
        
        .login-btn {
            background: linear-gradient(135deg, #4a8dbf, #2c7da0); padding: 10px 25px; border-radius: 25px;
            font-weight: 600; border: none; box-shadow: 0 4px 15px rgba(74, 141, 191, 0.3); color: white; text-decoration: none;
        }
        
        /* Language Dropdown */
        .language-dropdown { position: relative; }
        .language-btn {
            background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px;
        }
        .language-menu {
            position: absolute; top: calc(100% + 8px); right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-radius: 12px; min-width: 160px; opacity: 0; visibility: hidden;
            transform: translateY(-10px); transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 200;
        }
        .language-dropdown.active .language-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .language-option { display: block; padding: 10px 20px; color: #0a2647 !important; text-decoration: none; }

        /* Background Elements */
        .stars { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 4s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        
        .moon {
            position: absolute; width: 150px; height: 150px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #f0f8ff, #d4e8f5);
            box-shadow: 0 0 60px rgba(255, 255, 255, 0.4);
            top: 100px; right: 10%; animation: float 6s ease-in-out infinite; z-index: 1;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        .clouds { position: absolute; bottom: 0; width: 100%; height: 200px; overflow: hidden; z-index: 2; pointer-events: none; }
        .cloud { position: absolute; background: white; border-radius: 100px; opacity: 0.8; filter: blur(1px); }
        .cloud1 { width: 150px; height: 60px; bottom: 20px; left: 5%; animation: drift 20s linear infinite; }
        .cloud2 { width: 180px; height: 70px; bottom: 50px; left: 30%; animation: drift 25s linear infinite; }
        @keyframes drift { from { transform: translateX(-100px); } to { transform: translateX(100vw); } }

        /* --- TYPING CONTAINER --- */
        .typing-container {
            position: relative; z-index: 10; width: 90%; max-width: 1000px; margin: 40px auto;
            background: rgba(10, 38, 71, 0.6); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 20px;
        }

        /* Tabs */
        .mode-tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 5px; }
        .tab-btn {
            background: transparent; border: 2px solid rgba(255, 255, 255, 0.2);
            color: white; padding: 10px 25px; border-radius: 30px; font-size: 16px;
            cursor: pointer; transition: all 0.3s;
        }
        .tab-btn.active, .tab-btn:hover {
            background: #4a8dbf; border-color: #4a8dbf; box-shadow: 0 0 15px rgba(74, 141, 191, 0.4);
        }

        /* Controls */
        .controls-bar {
            display: flex; justify-content: space-between; background: rgba(0, 0, 0, 0.2);
            padding: 12px 20px; border-radius: 12px; flex-wrap: wrap; gap: 15px; align-items: center;
        }
        .control-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        
        select, .custom-text-btn, .action-btn {
            background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 15px; border-radius: 8px; cursor: pointer; outline: none; transition: all 0.3s;
            font-size: 14px;
        }
        select option { background: #0a2647; color: white; }
        
        .action-btn:hover, .custom-text-btn:hover {
            background: rgba(74, 141, 191, 0.4); border-color: #4a8dbf;
        }
        .btn-group { display: flex; gap: 8px; }

        /* --- STATS BOX (REFINED: Compact & Balanced) --- */
        .stats-box { 
            display: flex; justify-content: center; 
            margin-bottom: 10px; /* Reduced margin */
            margin-top: 5px;
        }
        .stat-item {
            /* Compact design matching controls */
            background: rgba(74, 141, 191, 0.1); 
            padding: 8px 25px; /* Smaller padding */
            border-radius: 12px;
            border: 1px solid rgba(74, 141, 191, 0.25);
            display: flex; flex-direction: column; align-items: center;
            min-width: 150px; /* Increased min-width to fit 00:00 comfortably */
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .stat-item:hover {
            transform: translateY(-2px);
            background: rgba(74, 141, 191, 0.15);
            border-color: #4a8dbf;
        }
        .stat-label { 
            color: #64b5f6; /* Lighter blue for better visibility */
            font-size: 11px; text-transform: uppercase; 
            letter-spacing: 1px; font-weight: 600; margin-bottom: 2px;
        }
        .stat-value-container {
            display: flex; align-items: baseline; gap: 4px;
        }
        .stat-value {
            font-size: 32px; /* Reduced from 42px to match controls better */
            font-weight: 700; line-height: 1;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
            color: white;
            font-variant-numeric: tabular-nums; /* Helps prevent jittering */
        }
        .stat-unit {
            font-size: 13px; color: rgba(255,255,255,0.5); font-weight: 500;
            display: none; /* Hide 's' unit as MM:SS is self-explanatory */
        }

        /* Typing Box */
        .typing-box {
            background: rgba(0, 0, 0, 0.3); border-radius: 16px; padding: 30px;
            min-height: 200px; font-family: 'Roboto Mono', monospace; font-size: 24px;
            line-height: 1.6; color: #64748b; position: relative; cursor: text;
            user-select: none; overflow: hidden; letter-spacing: 1px; word-break: break-all;
        }
        .typing-box:focus-within { box-shadow: 0 0 0 2px #4a8dbf; }

        /* Character Styles */
        .char { position: relative; transition: color 0.1s ease; }
        .char.correct { color: #4ade80; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
        .char.incorrect { color: #f87171; text-decoration: underline; background-color: rgba(248, 113, 113, 0.1); }
        .char.active { color: #4a8dbf; }
        .char.active::after {
            content: ''; position: absolute; left: 0; bottom: -2px; width: 100%; height: 3px;
            background-color: #4a8dbf; animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .input-field { position: absolute; z-index: -999; opacity: 0; top: 0; left: 0; }

        /* Beginner Visuals Container */
        .beginner-visuals {
            display: none; /* Default hidden */
            flex-direction: column; align-items: center;
            gap: 20px; margin-top: 10px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* Virtual Keyboard */
        .keyboard-wrapper {
            position: relative;
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 6px;
            user-select: none;
        }
        .row { display: flex; justify-content: center; gap: 6px; }
        .key {
            width: 45px; height: 45px; background: rgba(255,255,255,0.1);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; color: rgba(255,255,255,0.7);
            border-bottom: 3px solid rgba(0,0,0,0.3);
            transition: all 0.1s ease;
        }
        .key.wide { width: 80px; } 
        .key.space { width: 280px; }
        
        .key.active-key {
            background: #4a8dbf; color: white; transform: translateY(3px);
            border-bottom: none; box-shadow: 0 0 15px rgba(74, 141, 191, 0.8); border-color: #64b5f6;
        }

        /* --- LEVELS GRID --- */
        .levels-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .level-btn {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 15px; border-radius: 16px; color: white; cursor: pointer; text-align: left;
            display: flex; flex-direction: column; justify-content: flex-start;
            min-height: 100px; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
        }
        .level-btn:hover { 
            background: rgba(255,255,255,0.1); 
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.3);
        }
        .level-btn.active { 
            background: rgba(74, 141, 191, 0.2); 
            border-color: #4a8dbf; 
            box-shadow: 0 0 25px rgba(74, 141, 191, 0.2); 
        }
        .level-btn.active::before {
            content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%; background: #4a8dbf;
        }
        
        .level-sub { 
            font-size: 11px; font-weight: 600; text-transform: uppercase; 
            letter-spacing: 1.5px; color: #94a3b8; margin-bottom: 8px;
        }
        .level-main { 
            font-size: 20px; font-weight: 800; line-height: 1.2;
            color: #e2e8f0; text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .level-btn.active .level-main { color: #4ade80; }

        /* Result Overlay & Modal */
        .result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 38, 71, 0.95); border-radius: 16px;
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .result-overlay.active { display: flex; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #0a2647; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1);
        }
        .modal textarea {
            width: 100%; height: 150px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px; border-radius: 8px; margin: 15px 0;
        }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .menu-toggle { display: flex; }
            .typing-container { padding: 20px; width: 95%; }
            .beginner-visuals { display: none !important; }
            nav { padding: 20px 30px; }
            .levels-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            .controls-bar { flex-direction: column; align-items: stretch; }
            .control-group { justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="hero">
        <nav>
            <div class="nav-left">
                <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                    <span></span><span></span><span></span>
                </button>
                <div class="logo">NoobDev</div>
            </div>
            <div class="nav-links">
                <a href="index.html" data-translate="navHome">Home</a>
                <a href="about.html" data-translate="navAbout">About</a>
                <a href="tips.html" data-translate="navTips">Tips</a>
                <a href="FAQ.html" data-translate="navFAQ">FAQ</a>
                <a href="typing.html" data-translate="navTyping">Typing</a>
                
                <div class="language-dropdown">
                    <button class="language-btn" id="languageBtn"><span data-translate="navLanguage">Language</span> ▼</button>
                    <div class="language-menu">
                        <a href="#" data-lang="en" class="language-option active">English</a>
                        <a href="#" data-lang="vi" class="language-option">Vietnamese</a>
                    </div>
                </div>
                <a href="login.html" class="login-btn">Login</a>
            </div>
        </nav>

        <div class="side-menu" id="sideMenu">
            <ul>
                <li><a href="index.html" data-translate="navHome">Home</a></li>
                <li><a href="about.html" data-translate="navAbout">About</a></li>
                <li><a href="tips.html" data-translate="navTips">Tips</a></li>
                <li><a href="FAQ.html" data-translate="navFAQ">FAQ</a></li>
                <li><a href="typing.html" data-translate="navTyping">Typing</a></li>
            </ul>
        </div>

        <div class="stars" id="starsContainer"></div>
        <div class="moon"></div>
        <div class="clouds">
            <div class="cloud cloud1"></div>
            <div class="cloud cloud2"></div>
        </div>

        <div class="typing-container">
            <div class="mode-tabs">
                <button class="tab-btn active" onclick="switchMode('beginner')" data-translate="tabBeginner">Beginner</button>
                <button class="tab-btn" onclick="switchMode('master')" data-translate="tabMaster">Master</button>
            </div>

            <!-- Beginner Panel -->
            <div id="beginner-panel">
                <div class="levels-grid" id="levelsGrid"></div>
            </div>

            <!-- Master Panel -->
            <div id="master-panel" style="display: none;">
                <div class="controls-bar">
                    <div class="control-group">
                        <select id="textType">
                            <option value="sentences">Sentences</option>
                            <option value="numbers">Numbers Only</option>
                            <option value="special">Characters Only</option>
                        </select>
                        <select id="timeLimit">
                            <option value="30">30s</option>
                            <option value="60" selected>1m</option>
                            <option value="120">2m</option>
                            <option value="300">5m</option>
                        </select>
                    </div>
                    
                    <div class="btn-group">
                        <button class="action-btn" onclick="newTest()" data-translate="btnNew">New Test ↻</button>
                        <button class="action-btn" onclick="restartTest()" data-translate="btnRestartTest">Restart ↺</button>
                        <button class="custom-text-btn" id="customBtn" data-translate="btnCustom">Custom ✎</button>
                    </div>
                </div>
            </div>

            <!-- STATS BOX (Only Time Left - Compact) -->
            <div class="stats-box">
                <div class="stat-item stat-time">
                    <div class="stat-label" data-translate="statTime">Time Left</div>
                    <div class="stat-value-container">
                        <div class="stat-value" id="timeLeft">01:00</div>
                        <div class="stat-unit">s</div>
                    </div>
                </div>
            </div>

            <div class="typing-box" id="typingBox">
                <div class="result-overlay" id="resultOverlay">
                    <div class="result-title" data-translate="msgComplete">Test Complete!</div>
                    <div style="font-size: 20px; margin-bottom: 10px;">WPM: <b id="finalWpm" style="color:#fff">0</b></div>
                    <div style="font-size: 20px;">Accuracy: <b id="finalAcc" style="color:#fff">0%</b></div>
                    <div class="btn-group" style="margin-top:20px;">
                        <button class="login-btn" onclick="restartTest()" data-translate="btnRestartTest">Retry</button>
                        <button class="login-btn" onclick="newTest()" style="background:transparent; border:1px solid white" data-translate="btnNew">New Test</button>
                    </div>
                </div>
                <p id="quoteDisplay"></p>
            </div>
            
            <div class="beginner-visuals" id="visualAids">
                <div class="keyboard-wrapper" id="keyboardWrapper">
                    <div class="row">
                        <div class="key" data-key="1">1</div><div class="key" data-key="2">2</div><div class="key" data-key="3">3</div><div class="key" data-key="4">4</div><div class="key" data-key="5">5</div><div class="key" data-key="6">6</div><div class="key" data-key="7">7</div><div class="key" data-key="8">8</div><div class="key" data-key="9">9</div><div class="key" data-key="0">0</div><div class="key" data-key="-">-</div><div class="key" data-key="=">=</div><div class="key wide">BSP</div>
                    </div>
                    <div class="row">
                        <div class="key wide">TAB</div><div class="key" data-key="q">Q</div><div class="key" data-key="w">W</div><div class="key" data-key="e">E</div><div class="key" data-key="r">R</div><div class="key" data-key="t">T</div><div class="key" data-key="y">Y</div><div class="key" data-key="u">U</div><div class="key" data-key="i">I</div><div class="key" data-key="o">O</div><div class="key" data-key="p">P</div><div class="key" data-key="[">[</div><div class="key" data-key="]">]</div><div class="key">\</div>
                    </div>
                    <div class="row">
                        <div class="key wide" id="key-caps">CAPS</div><div class="key" data-key="a">A</div><div class="key" data-key="s">S</div><div class="key" data-key="d">D</div><div class="key" data-key="f">F</div><div class="key" data-key="g">G</div><div class="key" data-key="h">H</div><div class="key" data-key="j">J</div><div class="key" data-key="k">K</div><div class="key" data-key="l">L</div><div class="key" data-key=";">;</div><div class="key" data-key="'">'</div><div class="key wide">ENTER</div>
                    </div>
                    <div class="row">
                        <div class="key wide" id="key-shift-l">SHIFT</div><div class="key" data-key="z">Z</div><div class="key" data-key="x">X</div><div class="key" data-key="c">C</div><div class="key" data-key="v">V</div><div class="key" data-key="b">B</div><div class="key" data-key="n">N</div><div class="key" data-key="m">M</div><div class="key" data-key=",">,</div><div class="key" data-key=".">.</div><div class="key" data-key="/">/</div><div class="key wide" id="key-shift-r">SHIFT</div>
                    </div>
                    <div class="row">
                        <div class="key space" data-key=" ">SPACE</div>
                    </div>
                </div>
                <div style="font-size: 14px; opacity: 0.7; margin-top:5px; font-style: italic;">Next key is highlighted</div>
            </div>
            
            <input type="text" class="input-field" id="inputField">
            <div style="text-align: center; margin-top: 10px; font-size: 14px; opacity: 0.6;" data-translate="hintFocus">Click box to focus</div>
        </div>
    </div>

    <div class="modal" id="customModal">
        <div class="modal-content">
            <h3 data-translate="modalTitle">Enter Custom Text</h3>
            <textarea id="customTextInput" placeholder="Paste your text here..."></textarea>
            <div class="modal-btns">
                <button class="login-btn" onclick="closeModal()" style="background: transparent; border: 1px solid white;">Cancel</button>
                <button class="login-btn" onclick="applyCustomText()">Apply</button>
            </div>
        </div>
    </div>

    <script>
        const paragraphs = [
            "The quick brown fox jumps over the lazy dog.",
            "Technology is best when it brings people together.",
            "Success is not final, failure is not fatal.",
            "In the middle of difficulty lies opportunity.",
            "Happiness depends upon ourselves.",
            "Turn your wounds into wisdom.",
            "Life is what happens when you're busy making other plans.",
            "Get busy living or get busy dying."
        ];

        const beginnerLessons = [
            { id: 1, titleEn: "Keys F & J", titleVi: "Phím F & J", text: "fjfj fjfj fff jjj fjf jfj" },
            { id: 2, titleEn: "Keys D & K", titleVi: "Phím D & K", text: "dkdk dkdk ddd kkk dkd kdk" },
            { id: 3, titleEn: "Keys S & L", titleVi: "Phím S & L", text: "slsl slsl sss lll sls lsl" },
            { id: 4, titleEn: "Keys A & ;", titleVi: "Phím A & ;", text: "a;a; a;a; aaa ;;; a;a ;a;" },
            { id: 5, titleEn: "All Home Row", titleVi: "Hàng cơ sở (a-;)", text: "asdf jkl; asdf jkl;" },
            { id: 6, titleEn: "G, H & Words", titleVi: "G, H & Từ đơn", text: "hello world hello world" },
            { id: 7, titleEn: "T, Y, U, I", titleVi: "T, Y, U, I", text: "typing is fun typing is fun" },
            { id: 8, titleEn: "Sentences", titleVi: "Luyện câu", text: "keep practicing keep practicing" }
        ];

        const translations = {
            en: {
                navHome: "Home", navLanguage: "Language", 
                tabBeginner: "Beginner", tabMaster: "Master",
                labelType: "Type:", labelTime: "Time:", 
                btnCustom: "Custom", btnNew: "New Test ↻", btnRestartTest: "Restart ↺",
                statTime: "Time Left", statWPM: "WPM", statAcc: "Accuracy",
                msgComplete: "Test Complete!", btnRestart: "Try Again",
                hintFocus: "Click on the text box to start typing",
                modalTitle: "Enter Custom Text",
                level: "Level", 
                navAbout: "About", navTips: "Tips", navFAQ: "FAQ", navTyping: "Typing"
            },
            vi: {
                navHome: "Trang chủ", navLanguage: "Ngôn ngữ",
                tabBeginner: "Cơ bản", tabMaster: "Nâng cao",
                labelType: "Loại:", labelTime: "Thời gian:", 
                btnCustom: "Tự nhập", btnNew: "Bài mới ↻", btnRestartTest: "Làm lại ↺",
                statTime: "Thời gian", statWPM: "Tốc độ (từ/phút)", statAcc: "Độ chính xác",
                msgComplete: "Hoàn thành!", btnRestart: "Thử lại",
                hintFocus: "Nhấn vào khung để bắt đầu gõ",
                modalTitle: "Nhập văn bản của bạn",
                level: "Cấp độ", 
                navAbout: "Giới thiệu", navTips: "Mẹo", navFAQ: "Câu hỏi thường gặp", navTyping: "Gõ phím"
            }
        };

        let currentMode = 'beginner'; 
        let timer = null;
        let maxTime = 60;
        let timeLeft = maxTime;
        let charIndex = 0;
        let mistakes = 0;
        let isTyping = false;
        let currentText = "";
        let currentLang = localStorage.getItem('language') || 'en';

        const display = document.getElementById('quoteDisplay');
        const inputField = document.getElementById('inputField');
        const timeTag = document.getElementById('timeLeft');
        const resultOverlay = document.getElementById('resultOverlay');
        const levelsGrid = document.getElementById('levelsGrid');
        const visualAids = document.getElementById('visualAids');

        document.addEventListener('DOMContentLoaded', () => {
            generateStars();
            initTranslation();
            initMobileMenu();
            
            setTimeout(() => {
                resetGame();
            }, 100);

            document.querySelector('.typing-box').addEventListener('click', () => inputField.focus());
            inputField.addEventListener('input', initTyping);
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            document.getElementById('timeLimit').addEventListener('change', resetGame);
            document.getElementById('textType').addEventListener('change', resetGame);
            
            document.getElementById('customBtn').addEventListener('click', () => {
                document.getElementById('customModal').classList.add('active');
            });
        });

        function initMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const sideMenu = document.getElementById('sideMenu');
            if(menuToggle && sideMenu) {
                menuToggle.addEventListener('click', () => {
                    sideMenu.classList.toggle('active');
                });
                document.addEventListener('click', (e) => {
                    if (!sideMenu.contains(e.target) && !menuToggle.contains(e.target) && sideMenu.classList.contains('active')) {
                        sideMenu.classList.remove('active');
                    }
                });
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('beginner-panel').style.display = mode === 'beginner' ? 'block' : 'none';
            document.getElementById('master-panel').style.display = mode === 'master' ? 'block' : 'none';
            
            if(mode === 'beginner') {
                visualAids.style.display = 'flex';
                setTimeout(() => {
                    if(currentText.length > 0) highlightCurrentKey(currentText[charIndex]);
                }, 50);
            } else {
                visualAids.style.display = 'none';
            }
            resetGame();
        }

        function newTest() {
            resetGame(false);
        }

        function restartTest() {
            resetGame(true);
        }

        function loadParagraph() {
            if (currentMode === 'beginner') {
                if(!currentText) loadLevel(1); 
                return; 
            }

            const type = document.getElementById('textType').value;
            maxTime = parseInt(document.getElementById('timeLimit').value);
            
            if (type === 'sentences') {
                const randIndex = Math.floor(Math.random() * paragraphs.length);
                currentText = paragraphs[randIndex];
            } else if (type === 'numbers') {
                currentText = Array(50).fill(0).map(() => Math.floor(Math.random() * 100)).join(' ');
            } else if (type === 'special') {
                const chars = '!@#$%^&*()_+{}|:"<>?-=[]\';/.,';
                currentText = Array(40).fill(0).map(() => chars.charAt(Math.floor(Math.random() * chars.length))).join(' ');
            }

            renderText();
        }

        function loadLevel(id) {
            const lesson = beginnerLessons.find(l => l.id === id);
            currentText = lesson ? lesson.text : "Error loading lesson";
            
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.level-btn[data-id="${id}"]`);
            if(btn) btn.classList.add('active');

            maxTime = 300; 
            renderText();
        }

        // --- NEW HELPER: FORMAT TIME MM:SS ---
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function renderText() {
            display.innerHTML = "";
            currentText.split("").forEach(char => {
                let span = `<span class="char">${char}</span>`;
                display.innerHTML += span;
            });
            const firstChar = display.querySelectorAll(".char")[0];
            if(firstChar) firstChar.classList.add("active");
            
            timeLeft = maxTime;
            // Use formatTime here
            timeTag.innerText = formatTime(timeLeft);
            
            if(currentMode === 'beginner') highlightCurrentKey(currentText[0]);
        }

        function initTyping() {
            const characters = display.querySelectorAll(".char");
            let currentInputLength = inputField.value.length;
            
            if (!isTyping && currentInputLength > 0) {
                timer = setInterval(initTimer, 1000);
                isTyping = true;
            }

            if (currentInputLength < charIndex) {
                charIndex--; 
                if (characters[charIndex].classList.contains("incorrect")) mistakes--; 
                characters[charIndex].classList.remove("correct", "incorrect");
            }
            else if (currentInputLength > charIndex) {
                let typedChar = inputField.value.slice(-1); 
                if (characters[charIndex].innerText === typedChar) {
                    characters[charIndex].classList.add("correct");
                } else {
                    mistakes++;
                    characters[charIndex].classList.add("incorrect");
                }
                charIndex++; 
            }

            characters.forEach(span => span.classList.remove("active"));
            
            if (charIndex < characters.length) {
                characters[charIndex].classList.add("active");
                highlightCurrentKey(characters[charIndex].innerText);
            } else {
                finishGame();
                clearHighlights();
            }
        }

        function highlightCurrentKey(char) {
            if(currentMode !== 'beginner') return;
            clearHighlights();
            const lowerChar = char.toLowerCase();
            const keyEl = document.querySelector(`.key[data-key="${lowerChar}"]`);
            if(keyEl) keyEl.classList.add('active-key');
            if (char !== lowerChar || "!@#$%^&*()_+{}|:\"<>?".includes(char)) {
                const shiftL = document.getElementById('key-shift-l');
                const shiftR = document.getElementById('key-shift-r');
                if(shiftL) shiftL.classList.add('active-key');
                if(shiftR) shiftR.classList.add('active-key');
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.active-key').forEach(el => el.classList.remove('active-key'));
        }

        function initTimer() {
            if (timeLeft > 0) {
                timeLeft--;
                // Use formatTime here
                timeTag.innerText = formatTime(timeLeft);
            } else {
                finishGame();
            }
        }

        function finishGame() {
            clearInterval(timer);
            inputField.value = "";
            
            let timeSpent = maxTime - timeLeft;
            if(timeSpent === 0) timeSpent = 1; 
            
            let wpm = Math.round(((charIndex - mistakes) / 5) / (timeSpent) * 60);
            wpm = (wpm < 0 || !wpm || wpm === Infinity ? 0 : wpm);
            
            let acc = Math.round(((charIndex - mistakes) / charIndex) * 100);
            acc = (isNaN(acc) || acc < 0 ? 100 : acc);

            document.getElementById('finalWpm').innerText = wpm;
            document.getElementById('finalAcc').innerText = acc + "%";
            resultOverlay.classList.add('active');
            clearHighlights();
        }

        function resetGame(preserveText) {
            const shouldPreserve = preserveText === true;
            if (!shouldPreserve) {
                loadParagraph();
            } else {
                if(currentMode === 'master') maxTime = parseInt(document.getElementById('timeLimit').value);
                renderText();
            }
            clearInterval(timer);
            timeLeft = maxTime;
            charIndex = mistakes = 0;
            isTyping = false;
            inputField.value = ""; 
            // Use formatTime here
            timeTag.innerText = formatTime(timeLeft);
            
            resultOverlay.classList.remove('active');
            inputField.focus(); 
            
            if(currentMode === 'beginner') {
                setTimeout(() => {
                    if(currentText.length > 0) highlightCurrentKey(currentText[0]);
                }, 50);
            }
        }

        function initBeginnerGrid() {
            levelsGrid.innerHTML = "";
            const levelLabel = translations[currentLang].level; 

            beginnerLessons.forEach(l => {
                const btn = document.createElement('div');
                btn.className = 'level-btn';
                btn.setAttribute('data-id', l.id);
                
                const title = currentLang === 'vi' ? l.titleVi : l.titleEn;

                btn.innerHTML = `
                    <div class="level-sub">${levelLabel} ${l.id}</div>
                    <div class="level-main">${title}</div>
                `;
                btn.onclick = () => {
                    loadLevel(l.id);
                    resetGame(); 
                };
                levelsGrid.appendChild(btn);
            });
            
            const currentLesson = beginnerLessons.find(l => l.text === currentText);
            if(currentLesson) {
                const activeBtn = document.querySelector(`.level-btn[data-id="${currentLesson.id}"]`);
                if(activeBtn) activeBtn.classList.add('active');
            }
        }

        function applyCustomText() {
            const text = document.getElementById('customTextInput').value.trim();
            if (text) {
                currentText = text;
                document.getElementById('customModal').classList.remove('active');
                resetGame(true);
            }
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('active');
        }

        function generateStars() {
            const container = document.getElementById('starsContainer');
            for(let i=0; i<100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 2 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 4 + 's';
                container.appendChild(star);
            }
        }

        function initTranslation() {
            const btn = document.getElementById('languageBtn');
            const menu = document.querySelector('.language-menu');
            btn.addEventListener('click', (e) => { e.stopPropagation(); document.querySelector('.language-dropdown').classList.toggle('active'); });
            document.addEventListener('click', () => document.querySelector('.language-dropdown').classList.remove('active'));
            
            document.querySelectorAll('.language-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.preventDefault();
                    const lang = opt.getAttribute('data-lang');
                    translatePage(lang);
                    localStorage.setItem('language', lang);
                });
            });

            translatePage(currentLang);
        }

        function translatePage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if(translations[lang][key]) el.innerText = translations[lang][key];
            });
            
            initBeginnerGrid(); 
            
            document.querySelectorAll('.language-option').forEach(o => o.classList.remove('active'));
            document.querySelector(`.language-option[data-lang="${lang}"]`).classList.add('active');
            
            if(currentMode === 'beginner') {
                visualAids.style.display = 'flex';
                const chars = display.querySelectorAll('.char');
                if(chars.length > charIndex) highlightCurrentKey(chars[charIndex].innerText);
            }
        }
    </script>
</body>
</html>